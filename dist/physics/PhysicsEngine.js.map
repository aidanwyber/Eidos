{"version":3,"file":"PhysicsEngine.js","sourceRoot":"","sources":["../../src/physics/PhysicsEngine.ts"],"names":[],"mappings":"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","sourcesContent":["import { Vec } from '../geom/index';\r\nimport { Particle, Spring, SpringChain } from './index';\r\n\r\nexport class PhysicsEngine {\r\n\tparticles: Particle[] = [];\r\n\r\n\thasGravity = false;\r\n\tgravity = new Vec(0, 0.1);\r\n\r\n\thasWind = false;\r\n\twind = new Vec(0.1, 0);\r\n\r\n\thasFriction = false;\r\n\tfrictionCoefficient = 0.1;\r\n\r\n\thasDrag = false;\r\n\tdragCoefficient = 0.0;\r\n\r\n\thasBounce = false;\r\n\tbounceCoefficient = 0.8;\r\n\r\n\thasRepulsion = false;\r\n\trepulsionStrength = 10;\r\n\trepulsionRadius = 10;\r\n\r\n\thasDamping = true;\r\n\tdamping = 0.01;\r\n\r\n\thasMouseInteraction = true;\r\n\theldParticleIndex: number | null = null;\r\n\r\n\titers = 50;\r\n\ttimeStep = 1 / this.iters;\r\n\r\n\tmouse = new Vec(0, 0);\r\n\tisMouseDown = false;\r\n\r\n\twidth: number;\r\n\theight: number;\r\n\r\n\tconstructor(width: number, height: number) {\r\n\t\tthis.width = width;\r\n\t\tthis.height = height;\r\n\t\tdocument.body.addEventListener('mousemove', e => {\r\n\t\t\tthis.mouse.set(e.clientX, e.clientY);\r\n\t\t});\r\n\t\tdocument.body.addEventListener('mousedown', () => {\r\n\t\t\tthis.isMouseDown = true;\r\n\t\t});\r\n\t\tdocument.body.addEventListener('mouseup', () => {\r\n\t\t\tthis.isMouseDown = false;\r\n\t\t});\r\n\t}\r\n\r\n\taddParticle(p: Particle) {\r\n\t\tif (this.particles.indexOf(p) > -1) return;\r\n\t\tthis.particles.push(p);\r\n\t}\r\n\r\n\tupdateParticles() {\r\n\t\t// all accelerations first\r\n\t\tfor (let p of this.particles) {\r\n\t\t\tif (p.isLocked) continue;\r\n\r\n\t\t\t// physics properties\r\n\t\t\tif (this.hasGravity) {\r\n\t\t\t\tp.addForce(this.gravity);\r\n\t\t\t}\r\n\r\n\t\t\t// if (this.hasWind) {\r\n\t\t\t// \tp.addForce(this.wind);\r\n\t\t\t// }\r\n\r\n\t\t\tif (this.hasFriction) {\r\n\t\t\t\tlet friction = p.getVelocity().scale(-this.frictionCoefficient);\r\n\t\t\t\tp.addForce(friction);\r\n\t\t\t}\r\n\r\n\t\t\tif (this.hasDrag) {\r\n\t\t\t\tconst vel = p.getVelocity();\r\n\t\t\t\tlet drag = vel.normalizeTo(-this.dragCoefficient * vel.magSq());\r\n\t\t\t\tp.addForce(drag);\r\n\t\t\t}\r\n\r\n\t\t\tif (this.hasRepulsion) {\r\n\t\t\t\tconst rrSq = this.repulsionRadius * this.repulsionRadius;\r\n\t\t\t\tfor (let other of this.particles) {\r\n\t\t\t\t\tif (other === p) continue;\r\n\r\n\t\t\t\t\tlet dir = p.sub(other);\r\n\t\t\t\t\tlet distSq = dir.magSq();\r\n\t\t\t\t\tif (distSq < rrSq && distSq > 0) {\r\n\t\t\t\t\t\tdir.normalizeToSelf(this.repulsionStrength / distSq);\r\n\t\t\t\t\t\tp.addForce(dir);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (\r\n\t\t\t\tthis.hasMouseInteraction &&\r\n\t\t\t\tthis.heldParticleIndex === null &&\r\n\t\t\t\tthis.isMouseDown\r\n\t\t\t\t// && p.isHovered()\r\n\t\t\t) {\r\n\t\t\t\tthis.heldParticleIndex = this.particles.indexOf(p);\r\n\t\t\t}\r\n\r\n\t\t\t// // particle properties\r\n\t\t\t// if (p.hasLifespan) {\r\n\t\t\t// \tp.lifespan -= 1;\r\n\t\t\t// \tif (p.lifespan <= 0) {\r\n\t\t\t// \t\tthis.particles.splice(this.particles.indexOf(p), 1);\r\n\t\t\t// \t\tcontinue;\r\n\t\t\t// \t}\r\n\t\t\t// }\r\n\r\n\t\t\t// if (p.hasTrail) {\r\n\t\t\t// \tp.trail.push(p.copy());\r\n\t\t\t// \tif (p.trail.length > p.trailLength) {\r\n\t\t\t// \t\tp.trail.shift();\r\n\t\t\t// \t}\r\n\t\t\t// }\r\n\r\n\t\t\tif (p.springs !== null) {\r\n\t\t\t\tfor (let s of p.springs) {\r\n\t\t\t\t\ts.apply();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// now change positions based on accelerations\r\n\t\tfor (let p of this.particles) {\r\n\t\t\tif (p.isLocked) continue;\r\n\r\n\t\t\tp.force.scaleSelf(this.timeStep);\r\n\r\n\t\t\tif (this.hasDamping) {\r\n\t\t\t\tp.dampen(this.damping);\r\n\t\t\t}\r\n\r\n\t\t\tp.update();\r\n\r\n\t\t\tif (this.hasBounce) {\r\n\t\t\t\tif (p.x < p.radius) {\r\n\t\t\t\t\tp.x = p.radius;\r\n\t\t\t\t\tconst vel = p.getVelocity();\r\n\t\t\t\t\tp.setVelocity(\r\n\t\t\t\t\t\tnew Vec(vel.x * -this.bounceCoefficient, vel.y)\r\n\t\t\t\t\t);\r\n\t\t\t\t} else if (p.x >= this.width - p.radius) {\r\n\t\t\t\t\tp.x = this.width - p.radius;\r\n\t\t\t\t\tconst vel = p.getVelocity();\r\n\t\t\t\t\tp.setVelocity(\r\n\t\t\t\t\t\tnew Vec(vel.x * -this.bounceCoefficient, vel.y)\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t\tif (p.y < p.radius) {\r\n\t\t\t\t\tp.y = p.radius;\r\n\t\t\t\t\tconst vel = p.getVelocity();\r\n\t\t\t\t\tp.setVelocity(\r\n\t\t\t\t\t\tnew Vec(vel.x, vel.y * -this.bounceCoefficient)\r\n\t\t\t\t\t);\r\n\t\t\t\t} else if (p.y >= this.height - p.radius) {\r\n\t\t\t\t\tp.y = this.height - p.radius;\r\n\t\t\t\t\tconst vel = p.getVelocity();\r\n\t\t\t\t\tp.setVelocity(\r\n\t\t\t\t\t\tnew Vec(vel.x, vel.y * -this.bounceCoefficient)\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (\r\n\t\t\tthis.hasMouseInteraction &&\r\n\t\t\tthis.heldParticleIndex !== null &&\r\n\t\t\tthis.isMouseDown\r\n\t\t) {\r\n\t\t\tconst pHeld = this.particles[this.heldParticleIndex];\r\n\t\t\tpHeld?.set(this.mouse);\r\n\t\t\tpHeld?.clearVelocity();\r\n\t\t}\r\n\t}\r\n\r\n\tgetSprings() {\r\n\t\treturn [];\r\n\t}\r\n\r\n\tupdate() {\r\n\t\tfor (let i = 0; i < this.iters; i++) {\r\n\t\t\tthis.updateParticles();\r\n\t\t}\r\n\t}\r\n}\r\n"]}